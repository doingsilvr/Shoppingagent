import streamlit as st
import time
import random
import re
from openai import OpenAI

# =========================================================
# ê¸°ë³¸ ì„¤ì •
# =========================================================
st.set_page_config(page_title="AI ì‡¼í•‘ ì—ì´ì „íŠ¸", page_icon="ğŸ§", layout="wide")

# =========================================================
# GPT ì„¤ì •
# =========================================================
SYSTEM_PROMPT = """
ë„ˆëŠ” 'AI ì‡¼í•‘ ë„ìš°ë¯¸'ì´ë©° ì‚¬ìš©ìì˜ ë¸”ë£¨íˆ¬ìŠ¤ í—¤ë“œì…‹ ê¸°ì¤€ì„ íŒŒì•…í•´ ì¶”ì²œì„ ë•ëŠ” ì—­í• ì„ í•œë‹¤.

[ì—­í•  ê·œì¹™]
- ë„ˆëŠ” ì±—ë´‡ì´ ì•„ë‹ˆë¼ 'ê°œì¸ ì»¨ì‹œì–´ì§€' ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í†¤ìœ¼ë¡œ ë§í•œë‹¤.
- ì‚¬ìš©ìê°€ ë§í•œ ê¸°ì¤€ì€ ì•„ë˜ì˜ [ë©”ëª¨ë¦¬]ë¥¼ ì°¸ê³ í•´ ë°˜ì˜í•œë‹¤.
- ê¸°ì¤€ì„ ì˜ëª» ê¸°ì–µí•˜ë©´ ì•ˆ ë˜ê³ , **ì´ë¯¸ ì–¸ê¸‰ë˜ê±°ë‚˜ ë©”ëª¨ë¦¬ì— ìˆëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ë‹¤ì‹œ ë¬¼ì–´ë³´ì§€ ì•ŠëŠ”ë‹¤.**
- ìƒˆë¡œìš´ ê¸°ì¤€ì´ ë“±ì¥í•˜ë©´, 'ë©”ëª¨ë¦¬ì— ì¶”ê°€í•˜ë©´ ì¢‹ê² ë‹¤'ë¼ê³  ìì—°ìŠ¤ëŸ½ê²Œ ì œì•ˆí•œë‹¤.
- ë‹¨, ì‹¤ì œ ë©”ëª¨ë¦¬ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œëŠ” ì‹œìŠ¤í…œ(ì½”ë“œ)ì´ ì²˜ë¦¬í•˜ë¯€ë¡œ, ë„ˆëŠ” "ë‚´ê°€ ë©”ëª¨ë¦¬ì— ì €ì¥í–ˆë‹¤"ë¼ê³  ë‹¨ì •ì ìœ¼ë¡œ ë§í•˜ì§€ ë§ê³ 
Â  "ì´ ê¸°ì¤€ì„ ê¸°ì–µí•´ë‘˜ê²Œìš”" ì •ë„ë¡œ í‘œí˜„í•œë‹¤.
- ì‚¬ìš©ìê°€ ëª¨í˜¸í•˜ê²Œ ë§í•˜ë©´ ë¶€ë“œëŸ½ê²Œ êµ¬ì²´ì ìœ¼ë¡œ ë‹¤ì‹œ ë¬¼ì–´ë³¸ë‹¤.
- ì‚¬ìš©ìê°€ â€œì˜ ëª¨ë¥´ê² ì–´ / ê¸€ì„ / ì•„ì§ ìƒê° ì•ˆ í–ˆì–´â€ë¼ê³  ë§í•˜ë©´,
Â  â€œê·¸ë ‡ë‹¤ë©´ ì£¼ë¡œ ì–´ë–¤ ìƒí™©ì—ì„œ ì‚¬ìš©í•˜ì‹¤ ë•Œ ì¤‘ìš”í• ê¹Œìš”?â€ì™€ ê°™ì´ ì‚¬ìš© ìƒí™©ì„ ë¬»ëŠ”ë‹¤.
- ì‚¬ìš©ìëŠ” ë¸”ë£¨íˆ¬ìŠ¤ 'í—¤ë“œì…‹(ì˜¤ë²„ì´ì–´/ì˜¨ì´ì–´)'ì„ êµ¬ë§¤í•˜ë ¤ê³  í•œë‹¤. 'ì´ì–´í°' ë˜ëŠ” 'ì¸ì´ì–´' íƒ€ì…ì— ëŒ€í•œ ì§ˆë¬¸ì€ í”¼í•˜ë¼.

[ëŒ€í™” íë¦„ ê·œì¹™]
- ëŒ€í™” ì´ˆë°˜ì—ëŠ” ì‚¬ìš© ìš©ë„/ìƒí™© â†’ ê¸°ëŠ¥/ì°©ìš©ê°/ë°°í„°ë¦¬/ë””ìì¸/ë¸Œëœë“œ/ìƒ‰ìƒ â†’ ì˜ˆì‚° ìˆœìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë„“í˜€ ê°„ë‹¤.
- ë©”ëª¨ë¦¬ì— ì´ë¯¸ ìš©ë„/ìƒí™©/ê¸°ëŠ¥ ë“±ì˜ ê¸°ì¤€ì´ íŒŒì•…ë˜ì—ˆë‹¤ë©´, ë‹¤ìŒ ë‹¨ê³„ì˜ ì§ˆë¬¸ìœ¼ë¡œ ë„˜ì–´ê°€ë¼.
- ğŸš¨ ë””ìì¸/ìŠ¤íƒ€ì¼ ê¸°ì¤€ì´ íŒŒì•…ë˜ë©´, ë‹¤ìŒ ì§ˆë¬¸ì€ ì„ í˜¸í•˜ëŠ” ìƒ‰ìƒì´ë‚˜ êµ¬ì²´ì ì¸ ìŠ¤íƒ€ì¼(ë ˆíŠ¸ë¡œ, ë¯¸ë‹ˆë©€ ë“±)ì— ëŒ€í•œ ì§ˆë¬¸ìœ¼ë¡œ ì „í™˜í•˜ë¼.
- **ğŸš¨ [í•„ìˆ˜] ì¶”ì²œìœ¼ë¡œ ë„˜ì–´ê°€ê¸° ì „, ë°˜ë“œì‹œ ì˜ˆì‚°(ê°€ê²©ëŒ€)ì„ í™•ì¸í•˜ë¼.**
- ë©”ëª¨ë¦¬ê°€ 3ê°œ ì´ìƒ ëª¨ì´ë©´, ìŠ¤ìŠ¤ë¡œ â€œì§€ê¸ˆê¹Œì§€ ê¸°ì¤€ì„ ì •ë¦¬í•´ë³´ê² ë‹¤â€ê³  ì œì•ˆí•´ë„ ëœë‹¤.
- ì •ë¦¬ í›„ì—ëŠ” ì‚¬ìš©ìê°€ ì›í•˜ê±°ë‚˜ ë²„íŠ¼ì´ ëˆŒë¦¬ë©´, ì¶”ì²œì„ ì œì•ˆí•œë‹¤.
- ì¶”ì²œì„ ìš”ì²­ë°›ìœ¼ë©´ ì¶”ì²œ ì´ìœ ê°€ í¬í•¨ëœ êµ¬ì¡°í™”ëœ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ë§í•œë‹¤.
Â  (ì‹¤ì œ ê°€ê²©/ëª¨ë¸ ì •ë³´ëŠ” ì‹œìŠ¤í…œì´ ì¹´ë“œ í˜•íƒœë¡œ ë”°ë¡œ ë³´ì—¬ì¤„ ìˆ˜ ìˆë‹¤.)
- ì‚¬ìš©ìê°€ íŠ¹ì • ìƒí’ˆ(ë²ˆí˜¸)ì— ëŒ€í•´ ì§ˆë¬¸í•˜ë©´, ê·¸ ìƒí’ˆì— ëŒ€í•œ ì •ë³´, ë¦¬ë·°, ì¥ë‹¨ì  ë“±ì„ ìì„¸íˆ ì„¤ëª…í•˜ë©° êµ¬ë§¤ë¥¼ ì„¤ë“í•˜ê±°ë‚˜ ë³´ì¡°í•˜ëŠ” ëŒ€í™”ë¡œ ì „í™˜í•œë‹¤. - íŠ¹íˆ ìƒí’ˆ ì„¤ëª… ì‹œ, ì‚¬ìš©ìì˜ ë©”ëª¨ë¦¬ë¥¼ í™œìš©í•˜ì—¬ í•´ë‹¹ ì œí’ˆì„ ì‚¬ìš©í–ˆì„ ë•Œì˜ ê°œì¸í™”ëœ ê²½í—˜ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” í†¤ìœ¼ë¡œ ì„¤ëª…í•œë‹¤.

[ë©”ëª¨ë¦¬ í™œìš©]
- ì•„ë˜ì— ì œê³µë˜ëŠ” ë©”ëª¨ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëŒ€í™” ë‚´ìš©ì„ ìœ ì§€í•˜ë¼.
- ë©”ëª¨ë¦¬ì™€ ì‚¬ìš©ìì˜ ìµœì‹  ë°œì–¸ì´ ì¶©ëŒí•˜ë©´, â€œê¸°ì¡´ì— ~ë¼ê³  í•˜ì…¨ëŠ”ë°, ê¸°ì¤€ì„ ë°”ê¾¸ì‹¤ê¹Œìš”?â€ì²˜ëŸ¼ ì •ì¤‘í•˜ê²Œ í™•ì¸ ì§ˆë¬¸ì„ í•œë‹¤.

[ì¶œë ¥ ê·œì¹™]
- í•œ ë²ˆì— ë„ˆë¬´ ë§ì€ ì§ˆë¬¸ì„ í•˜ì§€ ë§ê³ , ìì—°ìŠ¤ëŸ½ê²Œ í•œë‘ ê°œì”©ë§Œ ë¬»ëŠ”ë‹¤.
- ì¤‘ë³µ ì§ˆë¬¸ì€ í”¼í•˜ê³ , ê¼­ í•„ìš”í•  ë•ŒëŠ” â€œë‹¤ì‹œ í•œ ë²ˆë§Œ í™•ì¸í• ê²Œìš”â€ë¼ê³  ë§í•œë‹¤.
- ì‚¬ìš©ìì˜ í‘œí˜„ì„ ì ë‹¹íˆ ë”°ë¼ê°€ë˜, ì „ì²´ í†¤ì€ ë¶€ë“œëŸ¬ìš´ ì¡´ëŒ“ë§ë¡œ ìœ ì§€í•œë‹¤.
"""

# Streamlit Cloudì—ì„œëŠ” Secretsì— OPENAI_API_KEY ì €ì¥
try:
    client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
except KeyError:
    st.error("âš ï¸ Streamlit Secretsì—ì„œ OPENAI_API_KEYë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.")
    client = None

# =========================================================
# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# =========================================================
def ss_init():
    ss = st.session_state
    ss.setdefault("nickname", None)
    ss.setdefault("page", "onboarding")       # onboarding -> chat
    ss.setdefault("stage", "explore")         # explore -> summary -> comparison -> product_detail
    ss.setdefault("messages", [])
    ss.setdefault("memory", [])               # list[str]
    ss.setdefault("summary_text", "")
    ss.setdefault("just_updated_memory", False)
    ss.setdefault("fixed_second_done", False)
    ss.setdefault("await_priority_choice", False)
    ss.setdefault("recommended_products", []) # ì´ì „ì— ì¶”ì²œí–ˆë˜ ìƒí’ˆ ì´ë¦„ ê¸°ë¡
    ss.setdefault("current_recommendation", []) # í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ì¶”ì²œ ìƒí’ˆ ëª©ë¡ ì €ì¥
ss_init()

# =========================================================
# ìœ í‹¸: ë©”ëª¨ë¦¬ ë¬¸ì¥ ìì—°í™”
# =========================================================
def naturalize_memory(text: str) -> str:
    """ë©”ëª¨ë¦¬ ë¬¸ì¥ì„ ì‚¬ìš©ì 1ì¸ì¹­ ìì—°ì–´ë¡œ ë‹¤ë“¬ê¸°."""
    t = text.strip()
    t = t.replace("ë…¸ì´ì¦ˆ ìº”ìŠ¬ë§", "ë…¸ì´ì¦ˆìº”ìŠ¬ë§")
    
    # ìµœìš°ì„  ê¸°ì¤€ í‘œì‹œ ìœ ì§€
    is_priority = "(ê°€ì¥ ì¤‘ìš”)" in t
    t = t.replace("(ê°€ì¥ ì¤‘ìš”)", "").strip()

    # ì´ì „ì— ì˜ëª» ì €ì¥ëœ ë©”ëª¨ë¦¬ í‘œì¤€í™”
    if "ì˜ˆì˜ë©´ ì¢‹ê² ì–´ë¡œ ìƒê°í•˜ê³  ìˆì–´ìš”" in t or "ì˜ˆì˜ë©´ ì¢‹ê² ì–´" in t:
        t = "ë””ìì¸/ìŠ¤íƒ€ì¼ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ê³  ìˆì–´ìš”."
        
    # ì¼ë°˜ì ì¸ ë¬¸ì¥ ì™„ì„± ë¡œì§
    if t.endswith(("ë‹¤", "ë‹¤.")):
        t = t.rstrip(".")
        if any(kw in t for kw in ["ì¤‘ìš”", "ì¤‘ì‹œ", "ì¤‘ìš”ì‹œ", "ìš°ì„ "]):
            t = t + "ê³  ìˆì–´ìš”."
        elif "ì´ë‚´" in t or "ì´ìƒ" in t or "ì •ë„" in t:
            t = t + "ë¡œ ìƒê°í•˜ê³  ìˆì–´ìš”."
        else:
            t = t + "ì´ì—ìš”."
    t = t.replace("ìƒê°í•œê³ ", "ìƒê°í•˜ê³ ")
    t = t.replace("ì´ë‚´ë‹¤", "ì´ë‚´ë¡œ ìƒê°í•˜ê³  ìˆì–´ìš”")
    
    # Fix for generic suffixing
    if not t.endswith(("ìš”.", "ë‹¤.", "ìš”")):
        if t.endswith("ìš”"):
            t += "."
        else:
            t += " "
            
    if is_priority:
        t = "(ê°€ì¥ ì¤‘ìš”) " + t

    return t

# =========================================================
# ë©”ëª¨ë¦¬ ì¶”ì¶œ ê·œì¹™
# =========================================================
def _clause_split(u: str) -> list[str]:
    # ë‹¤ì–‘í•œ ì ‘ì†ì‚¬(ë°, í•˜ê³ , ê³ , & ë“±)ë¥¼ ì‰¼í‘œë¡œ ë³€í™˜í•˜ì—¬ ë³µìˆ˜ì˜ ê¸°ì¤€ì„ ë¶„ë¦¬
    repl = re.sub(r"(ê·¸ë¦¬ê³ |ë‘|ë°|í•˜ê³ |ê³ |&|Â·)", ",", u)
    parts = [p.strip() for p in re.split(r"[ï¼Œ,]", repl) if p.strip()]
    return parts if parts else [u.strip()]

def memory_sentences_from_user_text(utter: str):
    """ì‚¬ìš©ì ë°œí™”ì—ì„œ ë³µìˆ˜ì˜ ì‡¼í•‘ ê¸°ì¤€/ë§¥ë½ì„ ì¶”ì¶œ."""
    u = utter.strip().replace("Â  ", " ")
    mems = []

    # ë‹¨ë‹µí˜• ì‘ë‹µì€ ë©”ëª¨ë¦¬ ì¶”ì¶œì„ ê±´ë„ˆë›°ì–´ ë¶ˆí•„ìš”í•œ ë©”ëª¨ë¦¬ ê¸°ì…ì„ ë°©ì§€
    if len(u) <= 3 and u in ["ì‘", "ë„¤", "ì˜ˆ", "ì•„ë‹ˆ", "ë‘˜ë‹¤", "ë‘˜ ë‹¤", "ë§ì•„", "ë§ì•„ìš”", "ã…‡ã…‡", "o", "x"]:
         return None
         
    # ìµœìš°ì„  ê¸°ì¤€ ê°ì§€
    is_priority_clause = False
    if re.search(r"(ê°€ì¥|ì œì¼|ìµœìš°ì„ |ì ¤)\s*(ì¤‘ìš”|ìš°ì„ )", u):
        is_priority_clause = True
        # ê¸°ì¡´ ìµœìš°ì„  ê¸°ì¤€ ì œê±°
        for i, m in enumerate(st.session_state.memory):
            st.session_state.memory[i] = m.replace("(ê°€ì¥ ì¤‘ìš”)", "").strip()
            
    # 1) ì˜ˆì‚°
    m = re.search(r"(\d+)\s*ë§Œ\s*ì›", u) 
    if m:
        price = m.group(1)
        # ì´ë¯¸ ì˜ˆì‚° ë©”ëª¨ë¦¬ê°€ ìˆë‹¤ë©´ ê¸°ì¡´ ê²ƒì„ ì‚­ì œí•˜ê³  ìƒˆë¡œìš´ ê²ƒìœ¼ë¡œ ì—…ë°ì´íŠ¸
        st.session_state.memory = [mem for mem in st.session_state.memory if "ì˜ˆì‚°" not in mem]
        
        mem = f"ì˜ˆì‚°ì€ ì•½ {price}ë§Œ ì› ì´ë‚´ë¡œ ìƒê°í•˜ê³  ìˆì–´ìš”."
        mems.append(f"(ê°€ì¥ ì¤‘ìš”) {mem}" if is_priority_clause else mem)

    # 2) ë¸Œëœë“œ (ìƒëµ)
    # 3) ìƒ‰ìƒ ë‹¨ë‹µ (ìƒëµ)
    
    # 4) ì ˆ(clause)ë³„ í‚¤ì›Œë“œ ê·œì¹™
    clauses = _clause_split(u)
    
    for c in clauses:
        base_rules = [
            ("ë…¸ì´ì¦ˆìº”ìŠ¬ë§", "ë…¸ì´ì¦ˆìº”ìŠ¬ë§ ê¸°ëŠ¥ì„ ê³ ë ¤í•˜ê³  ìˆì–´ìš”."),
            ("ANC", "ë…¸ì´ì¦ˆìº”ìŠ¬ë§ ê¸°ëŠ¥ì„ ê³ ë ¤í•˜ê³  ìˆì–´ìš”."),
            ("ì†ŒìŒ ì°¨ë‹¨", "ë…¸ì´ì¦ˆìº”ìŠ¬ë§ ê¸°ëŠ¥ì„ ê³ ë ¤í•˜ê³  ìˆì–´ìš”."),
            ("ì™¸ë¶€ ì†ŒìŒ", "ë…¸ì´ì¦ˆìº”ìŠ¬ë§ ê¸°ëŠ¥ì„ ê³ ë ¤í•˜ê³  ìˆì–´ìš”."),
            ("ì‹œë„ëŸ½ì§€ ì•Šê²Œ", "ë…¸ì´ì¦ˆìº”ìŠ¬ë§ ê¸°ëŠ¥ì„ ê³ ë ¤í•˜ê³  ìˆì–´ìš”."),
            
            ("ì˜ˆì˜ë©´", "ë””ìì¸/ìŠ¤íƒ€ì¼ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ê³  ìˆì–´ìš”."),
            ("ì˜ˆìœ", "ë””ìì¸/ìŠ¤íƒ€ì¼ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ê³  ìˆì–´ìš”."),
            ("ë””ìì¸", "ë””ìì¸/ìŠ¤íƒ€ì¼ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ê³  ìˆì–´ìš”."),
            ("ìŠ¤íƒ€ì¼", "ë””ìì¸/ìŠ¤íƒ€ì¼ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ê³  ìˆì–´ìš”."),
            
            ("ê°€ë³", "ê°€ë²¼ìš´ ì°©ìš©ê°ì„ ì„ í˜¸í•˜ê³  ìˆì–´ìš”."),
            ("ì°©ìš©ê°", "ì°©ìš©ê°ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ê³  ìˆì–´ìš”."),
            ("ìŒì§ˆ", "ìŒì§ˆì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ê³  ìˆì–´ìš”."),
            ("ë°°í„°ë¦¬", "ë°°í„°ë¦¬ ì§€ì†ì‹œê°„ì´ ê¸´ ì œí’ˆì„ ì„ í˜¸í•˜ê³  ìˆì–´ìš”."),
            ("ì¶œí‡´ê·¼", "ì¶œí‡´ê·¼ê¸¸ì— ì‚¬ìš©í•  ì˜ˆì •ì´ì—ìš”."),
            ("ìš´ë™", "ì£¼ë¡œ ëŸ¬ë‹/ìš´ë™ ìš©ë„ë¡œ ì‚¬ìš©í•  ì˜ˆì •ì´ì—ìš”."),
            ("ê²Œì„", "ì£¼ë¡œ ê²Œì„ ìš©ë„ë¡œ ì‚¬ìš©í•  ì˜ˆì •ì´ë©°, ì´ ì ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ê³  ìˆì–´ìš”."),
        ]
        
        matched = False
        for key, sent in base_rules:
            if key in c:
                mem = sent
                mems.append(f"(ê°€ì¥ ì¤‘ìš”) {mem}" if is_priority_clause else mem)
                matched = True

        # ëª…ì‹œì  ê·œì¹™ì— ê±¸ë¦¬ì§€ ì•Šê³  "~ì¢‹ê² ì–´/~í•„ìš”í•´" íŒ¨í„´ì— ê±¸ë¦¬ëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬
        if re.search(r"(í•˜ë©´ ì¢‹ê² |ì¢‹ê² ì–´|ê°€ ì¢‹ì•„|ì„ í˜¸|í•„ìš”í•´|ì¤‘ìš”í•´)", c) and not matched:
            if len(c.strip()) > 3 and not any(k in c for k in ["ì˜ˆì˜ë©´", "ë””ìì¸", "ìŠ¤íƒ€ì¼"]): 
                mem = c.strip() + "ë¡œ ìƒê°í•˜ê³  ìˆì–´ìš”."
                mems.append(f"(ê°€ì¥ ì¤‘ìš”) {mem}" if is_priority_clause else mem)
            matched = True

    # ì¤‘ë³µ ì œê±° ë° ìµœì¢… ì •ë¦¬
    dedup = []
    for m in mems:
        # ğŸŒŸ Fix: ë‹«íˆì§€ ì•Šì€ ê´„í˜¸ ì˜¤ë¥˜ ìˆ˜ì • (ë‘ ë²ˆì§¸ ì¸ìˆ˜ë¡œ ë¹ˆ ë¬¸ìì—´ ì¶”ê°€)
        m_stripped = m.replace("(ê°€ì¥ ì¤‘ìš”)", "").strip()
        is_duplicate = False
        for x in dedup:
            x_stripped = x.replace("(ê°€ì¥ ì¤‘ìš”)", "").strip()
            if m_stripped in x_stripped or x_stripped in m_stripped:
                is_duplicate = True
